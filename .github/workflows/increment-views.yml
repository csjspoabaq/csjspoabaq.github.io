name: Increment Monthly Views
on:
  repository_dispatch:
    types: [increment_view] # Matches event_type from the serverless function
 
jobs:
  update-count:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
 
      - name: Set up Ruby (to parse YAML)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
 
      - name: Update views.yml
        run: |
          # Get current month (e.g., "2024-04")
          CURRENT_MONTH=$(date +%Y-%m)
          DATA_FILE="_data/views.yml"
 
          # Load current counts from YAML
          CURRENT_COUNT=$(ruby -ryaml -e "data = YAML.load_file('$DATA_FILE'); puts data['current_month'] || 0")
          LAST_MONTH_IN_HISTORY=$(ruby -ryaml -e "data = YAML.load_file('$DATA_FILE'); puts data.dig('history', -1, 'month')")
 
          # Reset count if month has changed (e.g., April â†’ May)
          if [ "$LAST_MONTH_IN_HISTORY" != "$CURRENT_MONTH" ] && [ -n "$LAST_MONTH_IN_HISTORY" ]; then
            # Archive old count to history
            ruby -ryaml -e "data = YAML.load_file('$DATA_FILE'); data['history'] ||= []; data['history'] << { month: '$LAST_MONTH_IN_HISTORY', count: $CURRENT_COUNT }; data['current_month'] = 1; File.write('$DATA_FILE', data.to_yaml)"
          else
            # Increment current month's count
            NEW_COUNT=$((CURRENT_COUNT + 1))
            ruby -ryaml -e "data = YAML.load_file('$DATA_FILE'); data['current_month'] = $NEW_COUNT; File.write('$DATA_FILE', data.to_yaml)"
          fi
 
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update monthly view count"
          file_pattern: "_data/views.yml" # Only commit the updated data file